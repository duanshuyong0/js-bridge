#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var package = require('./package.json');

var dirPath = process.argv[2];

function replaceTmpl(data) {
  var json = JSON.parse(data);
  if (json.devDependencies && json.devDependencies[package.name]) {
    json.devDependencies[package.name] = package.version;
    return JSON.stringify(json, null, 2);
  }
  return false;
}

function writeFile(file, data) {
  fs.writeFile(file, data, function wf(err) {
    if (err) {
      throw Error(err);
    }
  });
}

function readFile(file, errCallback) {
  fs.readFile(file, function rf(err, data) {
    var strData;
    if (err) {
      return errCallback(err);
      // throw Error(err);
    }
    strData = replaceTmpl(data);
    if (strData) {
      writeFile(file, strData);
    }
    return false;
  });
}

function readdir(dir) {
  fs.readdir(dir, function rd(err, files) {
    if (err) {
      throw Error(err);
    }
    files.forEach(function fe(item) {
      var pitem = path.join(dir, item);
      fs.stat(pitem, function stat(err1, stats) {
        if (err1) {
          throw Error(err1);
        }
        if (stats.isDirectory()) {
          readFile(path.join(pitem, './package.json'), function (e) {
            // throw Error(e);
            console.warn(pitem, e.message);
          });
        }
      });
    });
  });
}

console.log('Path: ', dirPath);
readFile(path.join(dirPath, './package.json'), function () {
  readdir(dirPath);
});

